---
title: "URJC MDS TFM - Financial Credit Risk"
author: "Miguel García Sánchez"
date: "`r Sys.Date()`"
output:
 html_document:
  code_folding: hide
  toc: yes
  toc_float: TRUE
  toc_depth: 3 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# 1. Introducción 

El trabajo a desarrollar consiste en el análisis de un dataset relativo a datos de préstamos de entidades financieras, donde se quiere tratar de comprender cuales son las razones y características que llevan al llamado "default", así como modelos que pueden ayudar a predecirlo.

## 1.1. Desarrollo, programación y control de versiones

Se ha elegido para el desarrollo de una parte del trabajo el lenguaje de programación R (R version 4.2.2), cómo IDE de desarrollo RStudio (RStudio version 2022.12.0.353) y cómo herramienta de control de versiones GitHub (proyecto "/MDS_TFM" creado y vinculado al usuario Miguel_gs - "mgarciasanc2021"). 

**Link del proyecto en GitHub:** 
https://github.com/mgarciasanc2021/MDS_TFM

## 1.2. Paquetes R

```{r librerias, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
library(formatR)
library(readr)
library(ggplot2)
library(GGally)
library(dplyr)
library(tidyr)
library(missForest)
library(VIM)
library(formattable)
library(usmap)
library(cowplot)
library(corrplot)
library(MASS)
library(ggfortify)
library(nortest)
library(car)
library(lmtest)
library(PerformanceAnalytics)
library(Amelia)
library(ggthemes)
library(tidyverse)
library(tibble)
library(gridExtra)
#library(ggbiplot)
library(factoextra)
library(caret)
library(ISLR)
library(rpart)
library(rpart.plot)
library(rattle)
library(tsne)
library(Rtsne)
library(class)
library(ada)
library(factoextra)
library(cluster)
library(useful)
library(mgcv)
library(xgboost)
library(randomForest)
library(kernlab)
library(pROC)
#library(doMC)
library(ggpubr)
library(ROCR)

```

# 2. Conjunto de datos

El conjunto de datos elegido para el desarrollo del trabajo es "Credit Risk Dataset". Este dataset incluye información de clientes y préstamos contratados por estos en diferentes instituciones financiera.

**Link del data set:** <https://www.kaggle.com/datasets/laotse/credit-risk-dataset>.

## 2.1. Carga de los datos

El conjunto de datos "Credit Risk Dataset" contiene 12 columnas y 32.581 filas y lo obtenemos en formato .CSV. 

Inicialmente se han guardado los datos en un data frame llamado "fin_credrisk" y se ha realizado un estudio inicial sobre su contenido utilizando la función head y summary.

```{r cargas datos, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk<- read_csv("financial_credit_risk.csv")
head(fin_credrisk)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(fin_credrisk)

```

## 2.2. Definición de las variables

Empezando ya el análisis inicial del conjunto de datos que tenemos, vemos que las 12 variables que componen los datos pueden ser descritas como:

**Input variables o Variables de entrada/predictoras:**

* **person_age:** Edad de la persona que toma el crédito.
* **person_income:** Ingresos anuales en dólares de la persona que toma el crédito.
* **person_home_ownership:** Estado de la propiedad de la vivienda donde reside la persona que toma el crédito.
* **person_emp_length:** Periodo de tiempo en años desde que la persona que toma el crédito esta en situación laboral activa.
* **loan_intent:** Uso del crédito concedido.
* **loan_grade:** Calidad crediticia del crédito concedido.
* **loan_amnt:** Cantidad en dólares de crédito concedido.
* **loan_int_rate:** Tipo de interés en porcentaje del crédito concedido. 
* **loan_percent_income:** Porcentaje de lo que supone el préstamo sobre los ingresos anuales en dólares de la persona que toma el crédito.
* **cb_person_default_on_file:** Variable binaria que indica si la persona tomadora del crédito ha tenido antes una situación de impago o no.
* **cb_preson_cred_hist_length:** Duración en años del historial crediticio de la persona tomadora del crédito.

**Output variable o Variable de salida/respuesta/objetivo:**

* **loan_status:** Estado actual del crédito (suponiendo "1" como impagado o situación de default, y "0" no impagado)

## 2.3. Objetivo del análisis

El objetivo final del proyecto es conseguir llegar a un modelo que permita predecir el riesgo de impago o "default" que puede tener en cartera una institución financiera y saber si estamos ante créditos que van a poder ser devueltos por el cliente, o por si el contrario se van a quedar como impagados.

# 3. Limpieza inicial del conjunto de datos

## 3.1. Cambio de nombres y de tipo de variable de las columnas

Se ha decidido no realizar un cambio en el nombre de las variables que aparecen en las columnas de los datos, ya que ya se sigue un patrón de nombre sin espaciones y así no tendremos problemas con ello a futuro.

También se ha decidido de momento no realizar ningún cambio en el tipo de variable (tenemos variables numéricas y categóricas en el dataset). Cabría la posibilidad de tratar de transformar la variable "loan_status"en categórica en función de si estamos ante préstamos de crédito impagados ("default") o no.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
str(fin_credrisk)

```

# 4. Análisis de datos faltantes

Haciendo uso de la librería VIM y de la librería Amelia, analizamos la estructura que tienen los datos faltantes dentro de nuestro data set para ver y entender como se distribuyen y a que variables afecta. 

Se puede comprobar que la proporción de datos faltantes es de aproximadamente un 1%. Hay 895 observaciones con datos faltantes en la variable "person_emp_length" y 3.116 observaciones con datos faltantes en "loan_int_rate".

```{r dfdos, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(aggr(fin_credrisk,numbers=T,sortVar=T))

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
missmap(fin_credrisk, main="Missing Map")

```

# 5. Partición del conjunto de datos: data set training y data set test

Una vez vistos por encima la estructura general de los datos, pasamos a dividir el conjunto de datos en dos para diferenciar los que usaremos de entrenamiento de los que usaremos de test (viendo la cantidad de datos de la que disponemos, la distribución elegida ha sido: 20% test y 80% training). Establecemos una semilla que nos guarde de forma permanente la división que hacemos para que la distribución de los datos sea siempre la misma.

Guardamos además la partición de datos de test para ser utilizada a futuro para la validación del modelo final y pasamos a trabajar de aquí en adelante con la partición de training.

```{r p, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
set.seed(101)
sample <- sample.int(n=nrow(fin_credrisk), size=floor(.80*nrow(fin_credrisk)), replace = F)
fcr_train <- fin_credrisk[sample,]
fcr_test <- fin_credrisk[-sample,]
fcr_train
fcr_test

```

# 6. Detección, tratamiento e imputación de datos faltantes

Para la imputación de datos faltantes en las columnas "person_emp_length" y "loan_int_rate", se ha decidido reemplazar todos sus NAs según los valores medianos de las mismas variables a las que se referencian.

Con la función summary se comprueba que ya no hay más datos faltantes en el data set train.

```{r imputacion, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train$person_emp_length[is.na(fcr_train$person_emp_length)]<-median(fcr_train$person_emp_length,na.rm = TRUE)
fcr_train$loan_int_rate[is.na(fcr_train$loan_int_rate)]<-median(fcr_train$loan_int_rate,na.rm = TRUE)
summary(fcr_train)

```

# 7. EDA - Análisis exploratorio de datos

## 7.1. Análisis de la distribución de las variables

Analizamos como se distribuyen las diferentes variables de nuestro dataset.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>% keep(is.numeric) %>%  gather() %>% ggplot(aes(value,fill=key)) +facet_wrap(~ key, scales = "free") + geom_histogram(bins=sqrt(nrow(fcr_train)))+ theme(legend.position="none")

```





