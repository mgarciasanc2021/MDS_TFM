---
title: "URJC MDS TFM - Financial Credit Risk"
author: "Miguel García Sánchez"
date: "`r Sys.Date()`"
output:
 html_document:
  code_folding: hide
  toc: yes
  toc_float: TRUE
  toc_depth: 3 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```
# 1. Introducción 

El trabajo a desarrollar consiste en el análisis de un dataset relativo a datos de préstamos de entidades financieras, donde se quiere tratar de comprender cuales son las razones y características que llevan al llamado "default" o situación de impago, así como modelos que pueden ayudar a predecirlo.

## 1.1. Desarrollo, programación y control de versiones

Se ha elegido para el desarrollo de una parte del trabajo el lenguaje de programación R (R version 4.2.2), cómo IDE de desarrollo RStudio (RStudio version 2022.12.0.353) y cómo herramienta de control de versiones GitHub (proyecto "/MDS_TFM" creado y vinculado al usuario Miguel_gs - "mgarciasanc2021"). 

**Link del proyecto en GitHub:** 
https://github.com/mgarciasanc2021/MDS_TFM

## 1.2. Paquetes R

```{r librerias, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
library(formatR)
library(readr)
library(ggplot2)
library(GGally)
library(dplyr)
library(tidyr)
library(missForest)
library(VIM)
library(formattable)
library(usmap)
library(cowplot)
library(corrplot)
library(MASS)
library(ggfortify)
library(nortest)
library(car)
library(lmtest)
library(PerformanceAnalytics)
library(Amelia)
library(ggthemes)
library(tidyverse)
library(tibble)
library(gridExtra)
#library(ggbiplot)
library(factoextra)
library(caret)
library(ISLR)
library(rpart)
library(rpart.plot)
library(rattle)
library(tsne)
library(Rtsne)
library(class)
library(ada)
library(factoextra)
library(cluster)
library(useful)
library(mgcv)
library(xgboost)
library(randomForest)
library(kernlab)
library(pROC)
#library(doMC)
library(ggpubr)
library(ROCR)

```

# 2. Conjunto de datos

El conjunto de datos elegido para el desarrollo del trabajo es "Credit Risk Dataset". Este dataset incluye información de clientes y préstamos contratados por estos en diferentes instituciones financiera.

**Link del data set:** <https://www.kaggle.com/datasets/laotse/credit-risk-dataset>.

## 2.1. Carga de los datos

El conjunto de datos "Credit Risk Dataset" contiene 12 columnas y 32.581 filas y lo obtenemos en formato .CSV. 

Inicialmente se han guardado los datos en un data frame llamado "fin_credrisk" y se ha realizado un estudio inicial sobre su contenido utilizando la función head y summary.

```{r cargas datos, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk<- read_csv("financial_credit_risk.csv")
head(fin_credrisk)
count(fin_credrisk)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(fin_credrisk)

```

Sacando estos datos vemos algunas cosas importantes a comentar:

* La variable "person_age" tiene un valor máximo de 144 años.
* La variable "person_emp_length" tiene un valor máximo de 123 años.
* La variable "person_emp_length" tiene 895 registros con NAs.
* La variable "loan_interest_rate" tiene 3.116 registros con NAs.

## 2.2. Definición de las variables

Empezando ya el análisis inicial del conjunto de datos que tenemos, vemos que las 12 variables que componen los datos pueden ser descritas como:

**Input variables o Variables de entrada/predictoras:**

* **person_age:** Edad de la persona que toma el crédito.
* **person_income:** Ingresos anuales en dólares de la persona que toma el crédito.
* **person_home_ownership:** Estado de la propiedad de la vivienda donde reside la persona que toma el crédito.
* **person_emp_length:** Periodo de tiempo en años desde que la persona que toma el crédito esta en situación laboral activa.
* **loan_intent:** Uso del crédito concedido.
* **loan_grade:** Calidad crediticia del crédito concedido.
* **loan_amnt:** Cantidad en dólares de crédito concedido.
* **loan_int_rate:** Tipo de interés en porcentaje del crédito concedido. 
* **loan_percent_income:** Porcentaje de lo que supone el préstamo sobre los ingresos anuales en dólares de la persona que toma el crédito.
* **cb_person_default_on_file:** Variable binaria que indica si la persona tomadora del crédito ha tenido antes una situación de impago o no.
* **cb_preson_cred_hist_length:** Duración en años del historial crediticio de la persona tomadora del crédito.

**Output variable o Variable de salida/respuesta/objetivo:**

* **loan_status:** Estado actual del crédito (suponiendo "1" como impagado o situación de default, y "0" no impagado)

## 2.3. Objetivo del análisis

El objetivo final del proyecto es conseguir llegar a un modelo que permita predecir el riesgo de impago o "default" que puede tener en cartera una institución financiera y saber si estamos ante créditos que van a poder ser devueltos por el cliente, o por si el contrario se van a quedar como impagados.

# 3. Limpieza inicial del conjunto de datos

## 3.1. Cambio de nombres de las columnas

Se ha decidido no realizar un cambio en el nombre de las variables que aparecen en las columnas de los datos, ya que ya se sigue un patrón de nombre sin espaciones y así no tendremos problemas con ello a futuro.

## 3.2. Cambio de tipo de variable de las columnas

Vemos que en el dataset tenemos variables de tipo numéricas (num - col_double()) y de tipo texto o cadena de caractéres (chr - col_character()).

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
str(fin_credrisk)

```

Se ha decidido por ello realizar cambio en el tipo de variable de las que son cadena de caracter y pasarlas a variables categóricas.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk$person_home_ownership = as.factor(gsub("\\$",
    "", fin_credrisk$person_home_ownership))

fin_credrisk$loan_intent = as.factor(gsub("\\$",
    "", fin_credrisk$loan_intent))

fin_credrisk$loan_grade = as.factor(gsub("\\$",
    "", fin_credrisk$loan_grade))

fin_credrisk$cb_person_default_on_file = as.factor(gsub("\\$",
    "", fin_credrisk$cb_person_default_on_file))

```

Vemos que con el cambio tenemos en el dataset variables de tipo numéricas y categóricas

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
str(fin_credrisk)

```

Cabría la posibilidad de tratar de transformar la variable "loan_status"en categórica en función de si estamos ante préstamos de crédito impagados ("default") o no.

# 4. Análisis preliminar del conjunto de datos

## 4.1. Análisis de datos faltantes

Analizamos en mayor profundidad lo detectado anteriomente respecto a datos faltantes en el dataset:

* La variable "person_emp_length" tiene 895 registros con NAs.
* La variable "loan_interest_rate" tiene 3.116 registros con NAs.

Haciendo uso de la librería VIM y de la librería Amelia, analizamos la estructura que tienen los datos faltantes dentro de nuestro data set para ver y entender como se distribuyen y a que variables afecta. 

Se puede comprobar que la proporción de datos faltantes es de aproximadamente un 1%. Hay 895 observaciones con datos faltantes en la variable "person_emp_length" y 3.116 observaciones con datos faltantes en "loan_int_rate".

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(aggr(fin_credrisk,numbers=T,sortVar=T))

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
missmap(fin_credrisk, main="Missing Map")

```

### 4.1.2. Tratamiento e imputación de datos faltantes

Para la imputación de datos faltantes en las columnas "person_emp_length" y "loan_int_rate", se ha decidido reemplazar todos sus NAs según los valores medianos de las mismas variables a las que se referencian.

Con la función summary se comprueba que ya no hay más datos faltantes en el data set train.

```{r imputacion, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk$person_emp_length[is.na(fin_credrisk$person_emp_length)]<-median(fin_credrisk$person_emp_length,na.rm = TRUE)
fin_credrisk$loan_int_rate[is.na(fin_credrisk$loan_int_rate)]<-median(fin_credrisk$loan_int_rate,na.rm = TRUE)

summary(fin_credrisk)

```

## 4.2. Análisis de datos atípico o outliers

Analizamos en mayor profundidad lo detectado anteriomente respecto a datos atípico en el dataset:

* La variable "person_age" tiene un valor máximo de 144 años.
* La variable "person_emp_length" tiene un valor máximo de 123 años.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot(fin_credrisk$person_age, fin_credrisk$person_emp_length)

```

Vemos como hay algunos datos que si podemos considerar atípico. Hay dos registros con un historial laboral de la persona contratante del préstamo ("person_emp_length") de más de 120 años y 4 registros con una edad de la persona contratante del préstamo ("person_age") superior a 120 años. 

### 4.2.2. Tratamiento y eliminación de datos atípicos o outliers

Estos caso comentados son raros e ilógicos, y optamos finalmente por eliminarlos del dataset.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk <- fin_credrisk %>%
   filter(person_age < 120) %>%
   filter(person_emp_length < 120)

```


Mostramos el resultado de como queda ahora el dataset con esta modificación. Ya no tenemos ni atípico ni datos faltantes en el dataset. Ahora el dateset mantiene las 12 columnas, pero pasamos a tener 32.574 filas o registros.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(fin_credrisk)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
count(fin_credrisk)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot(fin_credrisk$person_age, fin_credrisk$person_emp_length)

```

# 5. Partición del conjunto de datos: data set training y data set test

Una vez vistos por encima la estructura general de los datos, pasamos a dividir el conjunto de datos en dos para diferenciar los que usaremos de entrenamiento de los que usaremos de test (viendo la cantidad de datos de la que disponemos, la distribución elegida ha sido: 20% test y 80% training). Establecemos una semilla que nos guarde de forma permanente la división que hacemos para que la distribución de los datos sea siempre la misma.

Guardamos además la partición de datos de test para ser utilizada a futuro para la validación del modelo final y pasamos a trabajar de aquí en adelante con la partición de training.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
set.seed(101)

sample <- sample.int(n=nrow(fin_credrisk), size=floor(.80*nrow(fin_credrisk)), replace = F)
fcr_train <- fin_credrisk[sample,]
fcr_test <- fin_credrisk[-sample,]
fcr_train
fcr_test

```

# 6. EDA - Análisis exploratorio de datos

## 6.1. Análisis de la distribución de las variables

Analizamos como se distribuyen las diferentes variables de entrada de nuestro dataset:

* **Variables numéricas relativas a la persona**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ga <- fcr_train %>%
    ggplot(aes(x = person_age)) + geom_histogram(bins =20,
    fill = "#619CFF")

gb <- fcr_train %>%
    ggplot(aes(x = person_income)) + geom_histogram(bins = 20,
    fill = "#E58700") + theme(axis.text.x = element_text(angle = 10, hjust = 0.5, vjust = 0.5))

gd <- fcr_train %>%
    ggplot(aes(x = person_emp_length)) + geom_histogram(bins = 20,
    fill = "#FD61D1")

gl <- fcr_train %>%
    ggplot(aes(x = cb_person_cred_hist_length)) + geom_histogram(bins = 20,
    fill = "#CDAD00")

grid.arrange(ga, gb, gd, gl)

```

- Modificamos a logaritmos??

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train <- fcr_train %>%
    mutate(Log_person_age = log(person_age), Log_person_income = log(person_income),
        Log_person_emp_length = log(person_emp_length), Log_cb_person_cred_hist_length = log(cb_person_cred_hist_length))

ga <- fcr_train %>%
    ggplot(aes(x = Log_person_age)) + geom_histogram(bins = 20,
    fill = "#619CFF")

gb <- fcr_train %>%
    ggplot(aes(x = Log_person_income)) + geom_histogram(bins = 20,
    fill = "#E58700") + theme(axis.text.x = element_text(angle = 10, hjust = 0.5, vjust = 0.5))

gd <- fcr_train %>%
    ggplot(aes(x = Log_person_emp_length)) + geom_histogram(bins = 20,
    fill = "#FD61D1")

gl <- fcr_train %>%
    ggplot(aes(x = Log_cb_person_cred_hist_length)) + geom_histogram(bins = 20,
    fill = "#CDAD00")

grid.arrange(ga, gb, gd, gl)

```

* **Variables numéricas relativas al préstamo**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
gg <- fcr_train %>%
    ggplot(aes(x = loan_amnt)) + geom_histogram(bins = 20,
    fill = "#8B2323")

gh <- fcr_train %>%
    ggplot(aes(x = loan_int_rate)) + geom_histogram(bins = 20,
    fill = "#00008B")

gj <- fcr_train %>%
    ggplot(aes(x = loan_percent_income)) + geom_histogram(bins = 20,
    fill = "#7FFF00")

grid.arrange(gg, gh, gj)

```

- Modificamos a logaritmos??

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train <- fcr_train %>%
    mutate(Log_loan_amnt = log(loan_amnt), Log_loan_int_rate = log(loan_int_rate),
        Log_loan_percent_income = log(loan_percent_income))

gg <- fcr_train %>%
    ggplot(aes(x = Log_loan_amnt)) + geom_histogram(bins = 20,
    fill = "#8B2323")

gh <- fcr_train %>%
    ggplot(aes(x = Log_loan_int_rate)) + geom_histogram(bins = 20,
    fill = "#00008B")

gj <- fcr_train %>%
    ggplot(aes(x = Log_loan_percent_income)) + geom_histogram(bins = 20,
    fill = "#7FFF00")

grid.arrange(gg, gh, gj)

```

* **Variables categóricas relativas a la persona**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
gc <- fcr_train %>%
    ggplot(aes(x = person_home_ownership)) + geom_histogram(bins = 20,
    fill = "#00CD00", stat="count")

gk <- fcr_train %>%
    ggplot(aes(x = cb_person_default_on_file)) + geom_histogram(bins = 20,
    fill = "#7FFFD4", stat="count")

grid.arrange(gc, gk)

```

* **Variables categóricas relativas al préstamo**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ge <- fcr_train %>%
    ggplot(aes(x = loan_intent)) + geom_histogram(bins = 20,
    fill = "#B983FF", stat="count") + theme(axis.text.x = element_text(angle = 10, hjust = 0.75, vjust = 0.75))

gf <- fcr_train %>%
    ggplot(aes(x = loan_grade)) + geom_histogram(bins = 20,
    fill = "#FFFF00", stat="count")

grid.arrange(ge, gf)

```

Analizamos como se distribuyen la variable objetivo de nuestro dataset:

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ggplot(data = fcr_train) + geom_bar(mapping = aes(x = loan_status, fill = as.factor(loan_status))) +
    labs(title = "Histograma del estado del crédito")

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
table(fcr_train$loan_status)

```
```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
prop.table(table(fcr_train$loan_status))

```

## 6.2. Boxplot - análisis de la variables de relevancia y de los atípicos observados

(LOGARITMOS??)

Analizamos si nuestras variables tienen valores atípicos, cuales son sus valores medios y vemos sus intervalos de confianza, a través de gráficos de tipo Boxplot.

* **Boxplot variable person_age**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_person_age <- ggplot(fcr_train, aes(x = factor(loan_status), y = person_age)) +
    geom_boxplot() + geom_boxplot(fill = "#619CFF") + ggtitle("Boxplot person_age")
BoxPlot_person_age

```

* **Boxplot variable person_income**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_person_income <- ggplot(fcr_train, aes(x = factor(loan_status), y = person_income)) +
    geom_boxplot() + geom_boxplot(fill = "#E58700") + ggtitle("Boxplot person_income")
BoxPlot_person_income

```

* **Boxplot variable person_emp_length**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_person_emp_length <- ggplot(fcr_train, aes(x = factor(loan_status), y = person_emp_length)) +
    geom_boxplot() + geom_boxplot(fill = "#FD61D1") + ggtitle("Boxplot person_emp_length")
BoxPlot_person_emp_length

```

* **Boxplot variable cb_person_cred_hist_length**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_cb_person_cred_hist_length <- ggplot(fcr_train, aes(x = factor(loan_status), y = cb_person_cred_hist_length)) + geom_boxplot() + geom_boxplot(fill = "#CDAD00") + ggtitle("Boxplot cb_person_cred_hist_length")
BoxPlot_cb_person_cred_hist_length

```

* **Boxplot variable loan_amnt**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_loan_amnt <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_amnt)) +
    geom_boxplot() + geom_boxplot(fill = "#8B2323") + ggtitle("Boxplot loan_amnt")
BoxPlot_loan_amnt

```

* **Boxplot variable loan_int_rate**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_loan_int_rate <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_int_rate)) +
    geom_boxplot() + geom_boxplot(fill = "#00008B") + ggtitle("Boxplot loan_int_rate")
BoxPlot_loan_int_rate

```

* **Boxplot variable loan_percent_income**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_loan_percent_income <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_percent_income)) +
    geom_boxplot() + geom_boxplot(fill = "#7FFF00") + ggtitle("Boxplot loan_percent_income")
BoxPlot_loan_percent_income

```







