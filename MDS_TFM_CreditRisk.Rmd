---
title: "URJC MDS TFM - Financial Credit Risk"
author: "Miguel García Sánchez"
date: "`r Sys.Date()`"
output:
 html_document:
  code_folding: hide
  toc: yes
  toc_float: TRUE
  toc_depth: 3 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# *INICIO DEL DESARROLLO DEL TRABAJO*

# 1. Introducción 

El trabajo a desarrollar consiste en el análisis de un dataset relativo a datos de préstamos de entidades financieras, donde se quiere tratar de comprender cuales son las razones y características que llevan al llamado "default" o situación de impago, así como modelos que pueden ayudar a predecirlo.

## 1.1. Desarrollo, programación y control de versiones

Se ha elegido para el desarrollo de una parte del trabajo el lenguaje de programación R (R version 4.2.2), cómo IDE de desarrollo RStudio (RStudio version 2022.12.0.353) y cómo herramienta de control de versiones GitHub (proyecto "/MDS_TFM" creado y vinculado al usuario Miguel_gs - "mgarciasanc2021"). 

**Link del proyecto en GitHub:** 
https://github.com/mgarciasanc2021/MDS_TFM

## 1.2. Paquetes R

```{r librerias, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
library(formatR)
library(readr)
library(ggplot2)
library(GGally)
library(dplyr)
library(tidyr)
library(missForest)
library(VIM)
library(formattable)
library(usmap)
library(cowplot)
library(corrplot)
library(MASS)
library(ggfortify)
library(nortest)
library(car)
library(lmtest)
library(PerformanceAnalytics)
library(Amelia)
library(ggthemes)
library(tidyverse)
library(tibble)
library(gridExtra)
#library(ggbiplot)
library(factoextra)
library(caret)
library(ISLR)
library(rpart)
library(rpart.plot)
library(rattle)
library(tsne)
library(Rtsne)
library(class)
library(ada)
library(factoextra)
library(cluster)
library(useful)
library(mgcv)
library(xgboost)
library(randomForest)
library(kernlab)
library(pROC)
#library(doMC)
library(ggpubr)
library(ROCR)
#library(ggextra)

```

# 2. Conjunto de datos

El conjunto de datos elegido para el desarrollo del trabajo es "Credit Risk Dataset". Este dataset incluye información de clientes y préstamos contratados por estos en diferentes instituciones financiera.

**Link del data set:** <https://www.kaggle.com/datasets/laotse/credit-risk-dataset>.

## 2.1. Carga de los datos

El conjunto de datos "Credit Risk Dataset" contiene 12 columnas y 32.581 filas y lo obtenemos en formato .CSV. 

Inicialmente se han guardado los datos en un data frame llamado "fin_credrisk" y se ha realizado un estudio inicial sobre su contenido utilizando la función head y summary.

```{r cargas datos, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk<- read_csv("financial_credit_risk.csv")
head(fin_credrisk)
count(fin_credrisk)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(fin_credrisk)

```

Sacando estos datos vemos algunas cosas importantes a comentar:

* La variable "person_age" tiene un valor máximo de 144 años.
* La variable "person_emp_length" tiene un valor máximo de 123 años.
* La variable "person_emp_length" tiene 895 registros con NAs.
* La variable "loan_interest_rate" tiene 3.116 registros con NAs.

## 2.2. Definición de las variables

Empezando ya el análisis inicial del conjunto de datos que tenemos, vemos que las 12 variables que componen los datos pueden ser descritas como:

**Input variables o Variables de entrada/predictoras:**

* **person_age:** Edad de la persona que toma el crédito.
* **person_income:** Ingresos anuales en dólares de la persona que toma el crédito.
* **person_home_ownership:** Estado de la propiedad de la vivienda donde reside la persona que toma el crédito.
* **person_emp_length:** Periodo de tiempo en años desde que la persona que toma el crédito está en situación laboral activa.
* **loan_intent:** Uso del crédito concedido.
* **loan_grade:** Calidad crediticia del crédito concedido.
* **loan_amnt:** Cantidad en dólares de crédito concedido.
* **loan_int_rate:** Tipo de interés en porcentaje del crédito concedido. 
* **loan_percent_income:** Porcentaje de lo que supone el préstamo sobre los ingresos anuales en dólares de la persona que toma el crédito.
* **cb_person_default_on_file:** Variable binaria que indica si la persona tomadora del crédito ha tenido antes una situación de impago o no.
* **cb_preson_cred_hist_length:** Duración en años del historial crediticio de la persona tomadora del crédito.

**Output variable o Variable de salida/respuesta/objetivo:**

* **loan_status:** Estado actual del crédito (suponiendo "1" como impagado o situación de default, y "0" no impagado)

## 2.3. Objetivo del análisis

El objetivo final del proyecto es conseguir llegar a un modelo que permita predecir el riesgo de impago o "default" que puede tener en cartera una institución financiera y saber si estamos ante créditos que van a poder ser devueltos por el cliente, o por si el contrario se van a quedar como impagados.

# *ANÁLISIS INICIAL, LIMPIEZA Y PARTICIONADO DE LOS DATOS*

# 3. Limpieza inicial del conjunto de datos

## 3.1. Cambio de nombres de las columnas

Se ha decidido no realizar un cambio en el nombre de las variables que aparecen en las columnas de los datos, ya que ya se sigue un patrón de nombre sin espaciones y así no tendremos problemas con ello a futuro.

## 3.2. Cambio de tipo de variable de las columnas

Vemos que en el dataset tenemos variables de tipo numéricas (num - col_double()) y de tipo texto o cadena de caractéres (chr - col_character()).

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
str(fin_credrisk)

```

Se ha decidido por ello realizar cambio en el tipo de variable de las que son cadena de caracter y pasarlas a variables categóricas.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk$person_home_ownership = as.factor(gsub("\\$",
    "", fin_credrisk$person_home_ownership))

fin_credrisk$loan_intent = as.factor(gsub("\\$",
    "", fin_credrisk$loan_intent))

fin_credrisk$loan_grade = as.factor(gsub("\\$",
    "", fin_credrisk$loan_grade))

fin_credrisk$cb_person_default_on_file = as.factor(gsub("\\$",
    "", fin_credrisk$cb_person_default_on_file))

```

Vemos que con el cambio tenemos en el dataset variables de tipo numéricas y categóricas

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
str(fin_credrisk)

```

Cabría la posibilidad de tratar de transformar la variable "loan_status"en categórica en función de si estamos ante préstamos de crédito impagados ("default") o no.

# 4. Análisis preliminar del conjunto de datos

## 4.1. Análisis de datos faltantes

Analizamos en mayor profundidad lo detectado anteriomente respecto a datos faltantes en el dataset:

* La variable "person_emp_length" tiene 895 registros con NAs.
* La variable "loan_interest_rate" tiene 3.116 registros con NAs.

Haciendo uso de la librería VIM y de la librería Amelia, analizamos la estructura que tienen los datos faltantes dentro de nuestro data set para ver y entender como se distribuyen y a que variables afecta. 

Se puede comprobar que la proporción de datos faltantes es de aproximadamente un 1%. Hay 895 observaciones con datos faltantes en la variable "person_emp_length" y 3.116 observaciones con datos faltantes en "loan_int_rate".

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(aggr(fin_credrisk,numbers=T,sortVar=T))

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
missmap(fin_credrisk, main="Missing Map")

```

### 4.1.2. Tratamiento e imputación de datos faltantes

Para la imputación de datos faltantes en las columnas "person_emp_length" y "loan_int_rate", se ha decidido reemplazar todos sus NAs según los valores medianos de las mismas variables a las que se referencian.

Con la función summary se comprueba que ya no hay más datos faltantes en el data set.

```{r imputacion, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk$person_emp_length[is.na(fin_credrisk$person_emp_length)]<-median(fin_credrisk$person_emp_length,na.rm = TRUE)
fin_credrisk$loan_int_rate[is.na(fin_credrisk$loan_int_rate)]<-median(fin_credrisk$loan_int_rate,na.rm = TRUE)

summary(fin_credrisk)

```

## 4.2. Análisis de datos atípico o outliers

Analizamos en mayor profundidad lo detectado anteriomente respecto a datos atípico en el dataset:

* La variable "person_age" tiene un valor máximo de 144 años.
* La variable "person_emp_length" tiene un valor máximo de 123 años.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot(fin_credrisk$person_age, fin_credrisk$person_emp_length)

```

Vemos como hay algunos datos que si podemos considerar atípico. Hay dos registros con un historial laboral de la persona contratante del préstamo ("person_emp_length") de más de 120 años y 4 registros con una edad de la persona contratante del préstamo ("person_age") superior a 120 años. 

### 4.2.2. Tratamiento y eliminación de datos atípicos o outliers

Estos caso comentados son raros e ilógicos, y optamos finalmente por eliminarlos del dataset.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fin_credrisk <- fin_credrisk %>%
   filter(person_age < 120) %>%
   filter(person_emp_length < 120)

```


Mostramos el resultado de como queda ahora el dataset con esta modificación. Ya no tenemos ni atípico ni datos faltantes en el dataset. Ahora el dateset mantiene las 12 columnas, pero pasamos a tener 32.574 filas o registros.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
summary(fin_credrisk)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
count(fin_credrisk)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot(fin_credrisk$person_age, fin_credrisk$person_emp_length)

```

# 5. Partición del conjunto de datos: data set training y data set test

Una vez vistos por encima la estructura general de los datos, pasamos a dividir el conjunto de datos en dos para diferenciar los que usaremos de entrenamiento de los que usaremos de test (viendo la cantidad de datos de la que disponemos, la distribución elegida ha sido: 20% test y 80% training). Establecemos una semilla que nos guarde de forma permanente la división que hacemos para que la distribución de los datos sea siempre la misma.

Guardamos además la partición de datos de test para ser utilizada a futuro para la validación del modelo final y pasamos a trabajar de aquí en adelante con la partición de training.

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
set.seed(101)

sample <- sample.int(n=nrow(fin_credrisk), size=floor(.80*nrow(fin_credrisk)), replace = F)
fcr_train <- fin_credrisk[sample,]
fcr_test <- fin_credrisk[-sample,]
fcr_train
fcr_test

```

# *ANÁLISIS EN PROFUNDIDAD DE LOS DATOS*

# 6. EDA - Análisis exploratorio de datos

## 6.1. Análisis de la distribución de las variables

Analizamos como se distribuyen las diferentes variables de entrada de nuestro dataset:

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>%
    keep(is.numeric) %>%
    gather() %>%
    ggplot(aes(value, fill = key)) + facet_wrap(~key, scales = "free") +
    geom_histogram(bins = sqrt(nrow(fcr_train))) + theme(legend.position = "none")

```

* **Variables numéricas relativas a la persona**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ga <- fcr_train %>%
    ggplot(aes(x = person_age)) + geom_histogram(bins =20,
    fill = "#619CFF")

gb <- fcr_train %>%
    ggplot(aes(x = person_income)) + geom_histogram(bins = 20,
    fill = "#E58700") + theme(axis.text.x = element_text(angle = 10, hjust = 0.5, vjust = 0.5))

gd <- fcr_train %>%
    ggplot(aes(x = person_emp_length)) + geom_histogram(bins = 20,
    fill = "#FD61D1")

gl <- fcr_train %>%
    ggplot(aes(x = cb_person_cred_hist_length)) + geom_histogram(bins = 20,
    fill = "#CDAD00")

grid.arrange(ga, gb, gd, gl)

```

- Modificamos a logaritmos??

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
#fcr_train <- fcr_train %>%
 #   mutate(Log_person_age = log(person_age), Log_person_income = log(person_income),
  #      Log_person_emp_length = log(person_emp_length), Log_cb_person_cred_hist_length = #log(cb_person_cred_hist_length))

#ga <- fcr_train %>%
    #ggplot(aes(x = Log_person_age)) + geom_histogram(bins = 20,
    #fill = "#619CFF")

#gb <- fcr_train %>%
    #ggplot(aes(x = Log_person_income)) + geom_histogram(bins = 20,
    #fill = "#E58700") + theme(axis.text.x = element_text(angle = 10, hjust = 0.5, vjust = 0.5))

#gd <- fcr_train %>%
    #ggplot(aes(x = Log_person_emp_length)) + geom_histogram(bins = 20,
    #fill = "#FD61D1")

#gl <- fcr_train %>%
    #ggplot(aes(x = Log_cb_person_cred_hist_length)) + geom_histogram(bins = 20,
    #fill = "#CDAD00")

#grid.arrange(ga, gb, gd, gl)

```

* **Variables numéricas relativas al préstamo**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
gg <- fcr_train %>%
    ggplot(aes(x = loan_amnt)) + geom_histogram(bins = 20,
    fill = "#8B2323")

gh <- fcr_train %>%
    ggplot(aes(x = loan_int_rate)) + geom_histogram(bins = 20,
    fill = "#00008B")

gj <- fcr_train %>%
    ggplot(aes(x = loan_percent_income)) + geom_histogram(bins = 20,
    fill = "#7FFF00")

grid.arrange(gg, gh, gj)

```

- Modificamos a logaritmos??

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
#fcr_train <- fcr_train %>%
    #mutate(Log_loan_amnt = log(loan_amnt), Log_loan_int_rate = log(loan_int_rate),
       #Log_loan_percent_income = log(loan_percent_income))

#gg <- fcr_train %>%
    #ggplot(aes(x = Log_loan_amnt)) + geom_histogram(bins = 20,
    #fill = "#8B2323")

#gh <- fcr_train %>%
    #ggplot(aes(x = Log_loan_int_rate)) + geom_histogram(bins = 20,
    #fill = "#00008B")

#gj <- fcr_train %>%
    #ggplot(aes(x = Log_loan_percent_income)) + geom_histogram(bins = 20,
    #fill = "#7FFF00")

#grid.arrange(gg, gh, gj)

```

* **Variables categóricas relativas a la persona**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
gc <- fcr_train %>%
    ggplot(aes(x = person_home_ownership)) + geom_histogram(bins = 20,
    fill = "#00CD00", stat="count")

gk <- fcr_train %>%
    ggplot(aes(x = cb_person_default_on_file)) + geom_histogram(bins = 20,
    fill = "#7FFFD4", stat="count")

grid.arrange(gc, gk)

```

* **Variables categóricas relativas al préstamo**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ge <- fcr_train %>%
    ggplot(aes(x = loan_intent)) + geom_histogram(bins = 20,
    fill = "#B983FF", stat="count") + theme(axis.text.x = element_text(angle = 10, hjust = 0.75, vjust = 0.75))

gf <- fcr_train %>%
    ggplot(aes(x = loan_grade)) + geom_histogram(bins = 20,
    fill = "#FFFF00", stat="count")

grid.arrange(ge, gf)

```

Analizamos como se distribuyen la variable objetivo de nuestro dataset:

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ggplot(data = fcr_train) + geom_bar(mapping = aes(x = loan_status, fill = as.factor(loan_status))) +
    labs(title = "Histograma del estado del crédito")

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
table(fcr_train$loan_status)

```
```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
prop.table(table(fcr_train$loan_status))

```

El 78.15% de los registros en nuestro dataset de train (20.365 registros) tiene valor 0 correspondiente a créditos que no han entrado en default, y el 21.85% (5.694 registros) tienen valor 1 correspondiente a créditos que por el contrario si han sido impagados.

## 6.2. Boxplot - análisis de la variables de relevancia y de los atípicos observados

(LOGARITMOS??)

Analizamos si nuestras variables tienen valores atípicos, cuales son sus valores medios y vemos sus intervalos de confianza, a través de gráficos de tipo Boxplot.

* **Boxplot variable person_age**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_person_age <- ggplot(fcr_train, aes(x = factor(loan_status), y = person_age)) +
    geom_boxplot() + geom_boxplot(fill = "#619CFF") + ggtitle("Boxplot person_age")
BoxPlot_person_age

```

Se aprecia como la variable "person_age" relativa a la edad del contratante del préstamo se mantiene bastante igual en los casos donde hay default o no hay default.

* **Boxplot variable person_income**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_person_income <- ggplot(fcr_train, aes(x = factor(loan_status), y = person_income)) +
    geom_boxplot() + geom_boxplot(fill = "#E58700") + ggtitle("Boxplot person_income")
BoxPlot_person_income

```

Se aprecia ligeramente como la variable "person_income" relativa a los ingresos anuales del contratante del préstamo, es inferior en media en los casos donde se da el impago del crédito.

* **Boxplot variable person_emp_length**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_person_emp_length <- ggplot(fcr_train, aes(x = factor(loan_status), y = person_emp_length)) +
    geom_boxplot() + geom_boxplot(fill = "#FD61D1") + ggtitle("Boxplot person_emp_length")
BoxPlot_person_emp_length

```

Se aprecia ligeramente como la variable "person_emp_length" relativa al periodo de tiempo en años desde que la persona que toma el crédito está en situación laboral activa, es inferior en media en los casos donde se da el impago del crédito.

* **Boxplot variable cb_person_cred_hist_length**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_cb_person_cred_hist_length <- ggplot(fcr_train, aes(x = factor(loan_status), y = cb_person_cred_hist_length)) + geom_boxplot() + geom_boxplot(fill = "#CDAD00") + ggtitle("Boxplot cb_person_cred_hist_length")
BoxPlot_cb_person_cred_hist_length

```

Se aprecia como la variable "person_cred_hist_length" relativa a la duración en años del historial crediticio de la persona tomadora del crédito, se mantiene bastante igual en los casos donde hay default o no hay default.

* **Boxplot variable loan_amnt**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_loan_amnt <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_amnt)) +
    geom_boxplot() + geom_boxplot(fill = "#8B2323") + ggtitle("Boxplot loan_amnt")
BoxPlot_loan_amnt

```

Se aprecia como la variable "loan_amount" relativa a la cantidad en dólares de crédito concedido, es superior en media en los casos donde se da el impago del crédito.

* **Boxplot variable loan_int_rate**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_loan_int_rate <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_int_rate)) +
    geom_boxplot() + geom_boxplot(fill = "#00008B") + ggtitle("Boxplot loan_int_rate")
BoxPlot_loan_int_rate

```

Se aprecia como la variable "loan_int_rate" relativa al tipo de interés en porcentaje del crédito concedido, es superior en media en los casos donde se da el impago del crédito.

* **Boxplot variable loan_percent_income**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
BoxPlot_loan_percent_income <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_percent_income)) +
    geom_boxplot() + geom_boxplot(fill = "#7FFF00") + ggtitle("Boxplot loan_percent_income")
BoxPlot_loan_percent_income

```

Se aprecia como la variable "loan_percent_income" relativa al porcentaje de lo que supone el préstamo sobre los ingresos anuales en dólares de la persona que toma el crédito, es superior en media en los casos donde se da el impago del crédito.


Como conclusión lógica de todo esto, normalmente el la situación de impago es más frecuente en personas con ingresos más bajos, menor número de años de actividad laboral y con préstamos de cantidades más altas y con tipos de interés elevados.

## 6.3. Correlación entre variables

Continuando con en análisis de las distintas variables del data set y el estudio de como se relacionan entre si, queremos ver de forma global como se correlacionan las variables numéricas que nos pueden llegar a servir para el modelo de predicción.

### 6.3.1. Análisis de la correlación global del conjunto de variables

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
corrplot(cor(fcr_train %>%
    mutate(loan_status = as.numeric(loan_status)) %>%
    keep(is.numeric)))
```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
res <- cor(fcr_train %>%
    mutate(loan_status = as.numeric(loan_status)) %>%
    keep(is.numeric))
round(res, 2)

```

Vemos que las variables que más estan correlacionadas con la variable “loan_status” son: “person_income”, “loan_amnt”, “loan_int_rate” y “loan_percent_income”.

### 6.3.2. Análisis de la correlación bivariante

Realizamos un análisis bivariante para ver que variables están más correlacionadas, positva o negativamente, entre si.

* **Correlación: person_age y cb_person_cred_hist_length:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
cor(x = fcr_train$person_age, y = fcr_train$cb_person_cred_hist_length)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>%
    ggplot(aes(person_age, cb_person_cred_hist_length)) + geom_point(alpha = 0.2,
    colour = "green") + geom_smooth(formula = "y ~ x", method = "lm") +
    labs(title = "Relación entre las variables person_age y cb_person_cred_hist_length",
        x = "person_age", y = "cb_person_cred_hist_length")

```

* **Correlación: loan_amnt y person_income:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
cor(x = fcr_train$loan_amnt, y = fcr_train$person_income)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>%
    ggplot(aes(loan_amnt, person_income)) + geom_point(alpha = 0.2,
    colour = "green") + geom_smooth(formula = "y ~ x", method = "lm") +
    labs(title = "Relación entre las variables loan_amnt y person_income",
        x = "loan_amnt", y = "person_income")

```

* **Correlación: loan_percent_income y person_income:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
cor(x = fcr_train$loan_percent_income, y = fcr_train$person_income)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>%
    ggplot(aes(loan_percent_income, person_income)) + geom_point(alpha = 0.2,
    colour = "green") + geom_smooth(formula = "y ~ x", method = "lm") +
    labs(title = "Relación entre las variables loan_percent_income y person_income",
        x = "loan_percent_income", y = "person_income")

```

* **Correlación: loan_percent_income y loan_amnt:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
cor(x = fcr_train$loan_percent_income, y = fcr_train$loan_amnt)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>%
    ggplot(aes(loan_percent_income, loan_amnt)) + geom_point(alpha = 0.2,
    colour = "green") + geom_smooth(formula = "y ~ x", method = "lm") +
    labs(title = "Relación entre las variables loan_percent_income y loan_amnt",
        x = "loan_percent_income", y = "loan_amnt")

```

* **Correlación: loan_status y loan_int_rate:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
cor(x = fcr_train$loan_status, y = fcr_train$loan_int_rate)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>%
    ggplot(aes(loan_status, loan_int_rate)) + geom_point(alpha = 0.2,
    colour = "green") + geom_smooth(formula = "y ~ x", method = "lm") +
    labs(title = "Relación entre las variables loan_status y loan_int_rate",
        x = "loan_status", y = "loan_int_rate")

```

* **Correlación: loan_status y loan_percent_income:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
cor(x = fcr_train$loan_status, y = fcr_train$loan_percent_income)

```

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
fcr_train %>%
    ggplot(aes(loan_status, loan_percent_income)) + geom_point(alpha = 0.2,
    colour = "green") + geom_smooth(formula = "y ~ x", method = "lm") +
    labs(title = "Relación entre las variables loan_status y loan_percent_income",
        x = "loan_status", y = "loan_percent_income")

```

## 6.4. Análisis de las variables categóricas

Se realiza un análisis de las variables categóricas en relación con el resto de variables numéricas del dataset. Se trata de entender las características personales de la gente y su actividad creditica para tratar de sacar un cierto análisis preliminar.

* **Variable person_home_ownership en función de las variables person_age y person_income:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot1 <- ggplot(fcr_train, aes(person_age, person_income, col=person_home_ownership)) +
  geom_point() + ylab("Income") + xlab("Age") + labs(color = "Home ownership: ") +
  theme(legend.position="bottom") 

ggExtra::ggMarginal(plot1, type = "boxplot")

```

En base a este gráfico podemos sacar como conclusión que: existe un sesgo en la edad (el dateset tiene más registros de gente joven), existe un sesgo en los ingresos (el dataset no tiene bien balanceada la variable "person_income", estando está desequilibrada y siendo más frecuente los ingresos bajos) y parece que la gente con hipoteca tiene por lo general más ingresos que la gente que vive de alquiler.

* **Variable loan_intent en función de las variables loan_amnt y loan_int_rate:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot2 <- ggplot(fcr_train, aes(loan_amnt, loan_int_rate, col=loan_intent)) +
  geom_point() + ylab("Interest rate") + xlab("Loan Amount") + labs(color = "Loan Intent: ") +
  theme(legend.position="bottom")

ggExtra::ggMarginal(plot2, type = "boxplot")

```

Este segundo gráfico obtenido, representa la relación entre el importe del préstamo solicitado y el tipo de interés aplicado. Aquí podemos ver que no hay una correlación clara entre las dos variables, por lo que podemos decir que no dependen la una de la otra. Además, parece que la intención de préstamo se distribuye por igual en la muestra, lo que significa que la intención no influye en absoluto en los tipos de interés ni en el importe del préstamo. En este caso, las distribuciones son gaussianas normales con un ligero sesgo.

* **Variable loan_grade en función de las variables loan_amnt y person_income:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot3 <- ggplot(fcr_train, aes(loan_amnt, person_income, col=loan_grade)) +
  geom_point() + ylab("Income") + labs(color = "Loan Grade: ") + theme(legend.position="bottom") +
  scale_color_manual(values=c("#66cc99", "#70F000", "#D0FF00", "#F3FF0F", "#FFDB4D", "#FFA64D", "#FF4D4D"))

ggExtra::ggMarginal(plot3, type = "boxplot")

```

En este tercer gráfico obtenido, tampoco existe una relación clara entre los ingresos y el importe del préstamo. Al añadir diferentes colores para las calificaciones de los préstamos, observamos una pequeña tendencia a que las personas con ingresos bajos y con un préstamo elevado tengan una calificación más baja. Pero no se aprecia una relación clara.

* **Variable loan_grade en función de las variables person_age y loan_int_rate:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot4 <- ggplot(fcr_train, aes(person_age, loan_int_rate, col=loan_grade)) +
  geom_point() + ylab("Interest rate") + xlab("Age") +  labs(color = "Loan Grade: ") +
theme(legend.position="bottom") + scale_color_manual(values=c("#66cc99", "#70F000", "#D0FF00", "#F3FF0F", "#FFDB4D", "#FFA64D", "#FF4D4D"))

ggExtra::ggMarginal(plot4, type = "boxplot")

```

En este cuarto gráfico se muestra la relación entre la edad, el tipo de interés y el grado del préstamo. Aquí podemos ver claramente que la calificación del préstamo depende del tipo de interés, que divide el gráfico en varias secciones. Básicamente dice que cuanto más alto es el tipo de interés, mayor es el riesgo percibido. Esto podría deberse al método de evaluación del grado de riesgo de las personas. Además, observamos que las personas mayores tienden a tener tipos de interés más bajos por término medio que los jóvenes.

## 6.5. Análisis de la variable de interés

Ahora se pasa a analizar nuestra variable de interes "loan_status", para ver la probabilidad de impago de un crédito o préstamo dadas ciertas características en el cliente o en el propio préstamos.

* **Variable loan_status en función de las variables loan_percent_income y loan_int_rate:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
plot5 <- ggplot(fcr_train, aes(loan_percent_income, loan_int_rate, col= factor(loan_status, labels = c("Not default", "Default")))) +
  geom_point() + ylab("Interest rate") + xlab("Loan percent income") + labs(color = "Loan Status: ") + 
  theme(legend.position="bottom") + scale_color_manual(values=c("#66cc99", "#ff3366"))

ggExtra::ggMarginal(plot5, type = "boxplot")

```

En este gráfico se vuelve a considerar el nivel de los tipos de interés, en relación con la proporción entre el importe del préstamo y los ingresos. La forma de los puntos sugiere que no hay una relación clara entre estas dos variables, lo que significa que los tipos de interés no dependen en absoluto del porcentaje de ingresos del préstamo. Sin embargo, cuanto más nos acercamos a un ratio más alto, más bajos son los tipos de interés.

Si analizamos a las personas que han impagado (en rojo) y a las personas que no han impagado (en verde), podemos ver claramente niveles de umbral hacia el 12% para los tipos de interés, y 0,3 para la variable de ingresos porcentuales del préstamo. Esta zona podría considerarse menos arriesgada tanto para los prestamistas como para los prestatarios. Esto parece razonable, ya que unos tipos de interés más altos y una mayor relación ingresos/préstamo significa que es menos probable que la gente reembolse su deuda.Es decir, a mayor nivel de tipo de interés del préstamos y un mayor nivel de endeudamiento en relación a los ingresos, es más probable que un cliente de una entidad bancaria termine por impagar su deuda.

* **Variable loan_status en función de la variable person_home_ownership:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ggplot(fcr_train, aes(x = factor(loan_status), fill = factor(person_home_ownership))) +
  geom_bar(position = "fill") +
  ylab("Home ownership %") + xlab("Default") + labs(fill = "Type of ownership:") +
  theme(legend.position="top", plot.background = element_rect(colour = "black", size = 1)) + 
  guides(fill = guide_legend(reverse=TRUE)) +
  coord_flip()

```

Con este gráfico se muestran las frecuencias absolutas del tipo de propiedad de la vivienda con respecto a las personas que han incurrido en impago del crédito. Se puede observar que típicamente quien paga un alquiler es más propenso al impago considerando todas las demás clases.

* **Variable loan_status en función de la variable loan_intent:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ggplot(fcr_train, aes(x = factor(loan_status), fill = factor(loan_intent))) +
  geom_bar(position = "fill") +
  ylab("Loan Intent") + xlab("Credit Default") + labs(fill = "Loan intent:") +
  theme(legend.position="top", plot.background = element_rect(colour = "black", size = 1)) + 
  guides(fill = guide_legend(reverse=TRUE)) +
  coord_flip()

```

Con este gráfico se pasa a comparar a las personas que han incumplido con el pago del préstamo y las que no, con la finalidad del préstamo solicitado. Como hemos señalado antes, la variable de la finalidad del préstamo está bien distribuida, sin embargo, cuando el préstamo se dedica a la consolidación de deudas y con fines médicos, parece más probable que se produzca un impago de la deuda.

* **Variable loan_status en función de la variable loan_grade:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
ggplot(fcr_train, aes(x = factor(loan_status), fill = factor(loan_grade))) +
  geom_bar(position = "fill") + scale_fill_manual(values=c("#66cc99", "#70F000", "#D0FF00", "#F3FF0F", "#FFDB4D", "#FFA64D", "#FF4D4D")) +
  ylab("Loan Grade") + xlab("Credit Default") + labs(fill = "Loan grade:") +
  theme(legend.position="top", plot.background = element_rect(colour = "black", size = 1)) + 
  guides(fill = guide_legend(reverse=TRUE)) +
  coord_flip()

```

Utilizando de nuevo la paleta de colores para el grado de riesgo, es posible observar que esta variable tiene cierto poder predictivo de los impagos de los tomadores de crédito. Según los datos, cuando el grado de riesgo es más bajo (calificación crediticia "A"), es menos probable que se produzca un impago. Lo contrario ocurre con los grados inferiores ("D", "E", "F" y "G")..

* **Variable loan_status en función de las variables loan_int_rate, person_income y loan_amnt:**

```{r, include=TRUE, message=FALSE, warning = FALSE,tidy=TRUE, tidy.opts=list(width.cutoff=60)}
g1 <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_int_rate)) + 
  geom_boxplot(fill = "orange", alpha = 0.2) +
  ylab("Interest rate") + xlab("Credit Default") +
  coord_flip() 

g2 <- ggplot(fcr_train, aes(x = factor(loan_status), y = person_income)) + 
  geom_boxplot(fill = "orange", alpha = 0.2) +
  ylab("Income") + xlab("Credit Default") +
  coord_flip() 

g3 <- ggplot(fcr_train, aes(x = factor(loan_status), y = loan_amnt)) + 
  geom_boxplot(fill = "orange", alpha = 0.2) +
  ylab("Loan Amount") + xlab("Credit Default") +
  coord_flip() 


grid.arrange(g1, g2, g3, ncol = 1, nrow = 3, top = "Default vs Interest rate, Income and Loan amount")

```

En este último gráfico se compara el riesgo de crédito con tres variables continuas: los tipos de interés, los ingresos anuales y el importe del préstamo. Este gráfico es interesante porque muestra claramente que unos tipos de interés más altos, unos ingresos más bajos y un crédito más elevado aumentan la posibilidad de impago.

# *APLICACIÓN DE LAS TÉCNICAS Y MODELOS DE MACHINE LEARNING*

# 7. Técnicas de reducción de la dimensionalidad


